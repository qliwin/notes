## 使用Laravel5.3 日常手记


### 使用服务容器绑定设置``模型工厂``默认填充中文数据
在``app\Providers\AppServiceProvider.php``的``register``方法中加入如下代码
```php
  // 设置模型工厂数据格式为中文
       $this->app->bind('Faker\Generator',function(){
           return Factory::create($locale = 'zh_CN');
       });
```

设置默认语言后，可以在工厂模型中使用一些方法生成符合国内格式的填充数据，比如中文姓名，中国手机号码等等，下面是一个简单的用户工厂
```php
$factory->define(App\User::class, function (Faker\Generator $faker) {
    return [
        'mobile' => $faker->phoneNumber, // 可以生产中国手机号格式的手机换号码
        'username' => $faker->name, // 可以生产中文姓名
        'realname' => $faker->word,
        'nickname' => $faker->word,
        'password' => bcrypt($faker->password),
        'email' => $faker->safeEmail,
        'avatar' => $faker->word,
        'gender' => $faker->word,
        'role_id' => $faker->randomNumber(),
        'status' => $faker->randomNumber(),
        'deleted_at' => $faker->dateTimeBetween(),
    ];
});

```

详细模型工厂的使用方式，请移步 [中文官方文档](https://laravel-china.org/docs/5.3/seeding#using-model-factories)

> 生成测试数据可以使用这个laravel扩展包：mpociot/laravel-test-factory-helper

扩展包GitHub地址：https://github.com/mpociot/laravel-test-factory-helper/



--- 


### 数据迁移migration正确使用步骤

一套流程走下来，总结如下：

1. 先执行 ``php artisan make:migration create_xxxx_table --create=xxx``生成所需的所有表的迁移文件

2. 在各迁移文件中写入相应字段和索引，不包含外键

3. 单独创建一个``增加外键``的迁移文件，比如``php artisan make:migration add_foreign_key``,在里面增加所有表的外键关系

> 为什么这样做呢，而不是在每个表的迁移文件中创建对应外键呢？因为，在最后执行``php artisan migrate``生成迁移文件时是按照创建迁移文件的顺序去创建数据表，这就会出现一个问题，比如有一张角色表和一张用户表，用户表的``role_id``外键连接到角色表的``id``，这样如果我们在创建迁移文件时先创建用户的迁移文件，后创建角色的迁移文件，那么在执行``php artisan migrate``的时候，就会报错，提示外键无法创建，无法创建是因为那个字段的外键的所属表还不存在，而为了避免这种问题出现，比较好的解决方法，就是先将所有迁移文件创建好，最后再添加一个迁移文件去给所有需要增加外键的字段创建外键关系，这个时候，所有数据表都已经存在，也就不会有上面所说的问题出现

4. 使用扩展或者手动创建对应数据表的Model文件

---


### 自定义验证规则方法

为什么要自定义验证规则，因为Laravel框架本身给我们提供的验证规则是有限的，很多时候我们需根据自己的实际需求去增加对应的验证方法，比如我们现在需要增加一个验证中国手机号码格式的方法，如下：

#### 增加验证规则方式如下

在AppServiceProvider.php中的boot方法中定义一个验证规则，验证规则格式如下:
```php
 Validator::extend('foo', function($attribute, $value, $parameters, $validator) {

     // do something to deal $value ...
    
     // 返回处理后的值
     return $value == 'foo';
});
```

#### 下面是增加一个中国手机号码格式验证规则

```php
  \Validator::extend('mobile',function($attribute,$value,$parameters,$validator){
            return preg_match('/^1(3[0-9]|4[57]|5[0-35-9]|7[0135678]|8[0-9])\\d{8}$/',$value);
      });
```

> 注：当我们自己创建的验证规则过多时，boot方法中就会显得特别臃肿，违反了Laravel一贯优雅的写法，所以当我们需要增加多个验证规则时，我们可以去创建一个``trait``文件，在里面创建一个方法用来创建这些验证规则，然后在AppServiceProvider.php中use过来，并在boot方法中调用即可，关于``trait``后面详细说