### 学习Yii2.0

#### 通过composer安装框架

1. 安装composer
> composer中文站：http://www.phpcomposer.com/

2. 安装composer Asset插件
```
php composer.phar global require "fxp/composer-asset-plugin:^1.2.0"
```
3. 安装YII2.0程序模板（以Yii2.0.9为例）
- 基础模板
```
php composer.phar create-project yiisoft/yii2-app-basic basic 2.0.9
```
- 高级模板
```
php composer.phar create-project yiisoft/yii2-app-advanced advanced 2.0.9
```

#### 初始化（高级模板）

1. 进入安装目录，执行  php init 进行项目初始化
2. 配置文件目录：/common/config/main.php
3. 本地数据库配置文件目录：/common/config/main-local.php
4. 配置URL规则
进入前后台对应站点配置文件目录，即：backend/config/main.php,/frontend/config/main.php 找到如下代码，去掉注释的代码就ok了
```
'urlManager' => [
            'enablePrettyUrl' => true,
            'showScriptName' => false,
            'rules' => [
            ],
        ],
```
5. 重写URL，去掉URL中的index.php（需要开启apache的rewrite模块）,然后在前后台的入口文件中加入.htaccess,文件内容如下
```
Options +FollowSymLinks
IndexIgnore */*


RewriteEngine on


# if a directory or a file exists, use it directly
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d


# otherwise forward it to index.php
RewriteRule . index.php
```


#### 后台用户添加
1. 后台模板AdminLTE的整合
AdminLTE是一个基于bootstrap开发的后台模板，具有很多炫酷吊炸天的控件和效果，非常适合作为网站后台管理的模板。
- 使用composer安装
```
composer require dmstr/yii2-adminlte-asset "2.*"
```
安装完成之后，我们就可以使用了。由于菜单配置项在vendor目录下，我们不能随便修改，所以我吗可以直接copy示例的代码使用。copy整个vendor/dmstr/yii2-adminlte-asset/example-views/yiisoft/yii2-app下的layouts和site到backend/views，覆盖原始文件。

2. 创建后台管理员Admin数据表
```Sql
DROP TABLE IF EXISTS `admin`;
CREATE TABLE `admin` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `auth_key` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  `password_hash` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `password_reset_token` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,
  `email` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `status` smallint(6) NOT NULL DEFAULT '1',
  `created_at` datetime NOT NULL,
  `updated_at` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `email` (`email`),
  UNIQUE KEY `password_reset_token` (`password_reset_token`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

```

3. 使用脚手架工具GII生成对应模型和CRUD，附图供参考
> 生成Model

![](http://ww3.sinaimg.cn/large/6aedb651gw1fbejk5cpodj211g0qin1d.jpg)

> 生成CRUD

![](http://ww2.sinaimg.cn/large/6aedb651gw1fbejkh14dvj211g0nzwiz.jpg)

4. 修改生成的Admin的Model模型
- 继承IdentityInterface接口，并实现其所有方法,重写默认模型的行为增加自动添加特定字段，重写beforeSave()方法，在保存到数据库之前，即save()方法执行之前执行密码加密等操作，代码如下
```php

<?php

namespace backend\models;

use Yii;
use yii\behaviors\TimestampBehavior;
use yii\web\IdentityInterface;

/**
 * This is the model class for table "admin".
 *
 * @property integer $id
 * @property string $username
 * @property string $auth_key
 * @property string $password_hash
 * @property string $password_reset_token
 * @property string $email
 * @property integer $status
 * @property integer $created_at
 * @property integer $updated_at
 */
class Admin extends \yii\db\ActiveRecord implements IdentityInterface
{
    // 表单的password字段
    public $password;

    // 账号状态
    const STATUS_ACTIVE = 1;
    const STATUS_Delete = 0;

    /**
     * 表名
     */
    public static function tableName()
    {
        return 'admin';
    }

    /**
     * 行为，自动执行
     * @return array
     */
    public function behaviors()
    {
        parent::behaviors(); // TODO: Change the autogenerated stub
        return [
            [
                'class' => TimestampBehavior::className(),
                'createdAtAttribute' => 'created_at',
                'updatedAtAttribute' => 'updated_at',
                'value' =>function(){
                    return date("Y-m-d H:i:s",time());
                },
            ],

        ];
    }

    /**
     * 自动验证规则
     */
    public function rules()
    {
        return [
            [['username', 'password', 'email'], 'required', 'message' => '不能为空'],
            [['password'], 'string', 'min' => 6, 'max' => 32, 'message' => '密码字符长度在6到32之间'],
            [['username', 'email'], 'string', 'max' => 255, 'message' => '字符过长'],
            [['username', 'email'], 'unique', 'message' => '已存在'],
            [['email'], 'email', 'message' => '邮箱格式不正确'],
            [['status'], 'default', 'value' => self::STATUS_ACTIVE],

        ];
    }

    /**
     * 属性标签
     */
    public function attributeLabels()
    {
        return [
            'id' => Yii::t('app', 'ID'),
            'username' => Yii::t('app', 'Username'),
            'auth_key' => Yii::t('app', 'Auth Key'),
            'password_hash' => Yii::t('app', 'Password Hash'),
            'password_reset_token' => Yii::t('app', 'Password Reset Token'),
            'email' => Yii::t('app', 'Email'),
            'status' => Yii::t('app', 'Status'),
            'created_at' => Yii::t('app', 'Created At'),
            'updated_at' => Yii::t('app', 'Updated At'),
        ];
    }

    /**
     * @inheritdoc
     */
    public static function findIdentity($id)
    {
        return static::findOne(['id' => $id, 'status' => self::STATUS_ACTIVE]);
    }

    /**
     * @inheritdoc
     */
    public static function findIdentityByAccessToken($token, $type = null)
    {
        throw new NotSupportedException('"findIdentityByAccessToken" is not implemented.');
    }

    /**
     * Finds user by username
     *
     * @param string $username
     * @return static|null
     */
    public static function findByUsername($username)
    {
        return static::findOne(['username' => $username, 'status' => self::STATUS_ACTIVE]);
    }

    /**
     * Finds user by password reset token
     *
     * @param string $token password reset token
     * @return static|null
     */
    public static function findByPasswordResetToken($token)
    {
        if (!static::isPasswordResetTokenValid($token)) {
            return null;
        }

        return static::findOne([
            'password_reset_token' => $token,
            'status' => self::STATUS_ACTIVE,
        ]);
    }

    /**
     * Finds out if password reset token is valid
     *
     * @param string $token password reset token
     * @return boolean
     */
    public static function isPasswordResetTokenValid($token)
    {
        if (empty($token)) {
            return false;
        }

        $timestamp = (int)substr($token, strrpos($token, '_') + 1);
        $expire = Yii::$app->params['user.passwordResetTokenExpire'];
        return $timestamp + $expire >= time();
    }

    /**
     * @inheritdoc
     */
    public function getId()
    {
        return $this->getPrimaryKey();
    }

    /**
     * @inheritdoc
     */
    public function getAuthKey()
    {
        return $this->auth_key;
    }

    /**
     * @inheritdoc
     */
    public function validateAuthKey($authKey)
    {
        return $this->getAuthKey() === $authKey;
    }

    /**
     * Validates password
     *
     * @param string $password password to validate
     * @return boolean if password provided is valid for current user
     */
    public function validatePassword($password)
    {
        return Yii::$app->security->validatePassword($password, $this->password_hash);
    }

    /**
     * Generates password hash from password and sets it to the model
     *
     * @param string $password
     */
    public function setPassword($password)
    {
        $this->password_hash = Yii::$app->security->generatePasswordHash($password);
    }

    /**
     * Generates "remember me" authentication key
     */
    public function generateAuthKey()
    {
        $this->auth_key = Yii::$app->security->generateRandomString();
    }

    /**
     * Generates new password reset token
     */
    public function generatePasswordResetToken()
    {
        $this->password_reset_token = Yii::$app->security->generateRandomString() . '_' . time();
    }

    /**
     * Removes password reset token
     */
    public function removePasswordResetToken()
    {
        $this->password_reset_token = null;
    }

    /**
     * 写入数据看之前执行，密码加密和生成auth key
     * @param bool $insert
     * @return bool
     */
    public function beforeSave($insert)
    {

        parent::beforeSave($insert);

        if (!empty($this->password)) {
            $this->setPassword($this->password);
        }
        if (empty($this->auth_key)) {
            $this->generateAuthKey();
        }
        return true;
    }
}

```

5. 修改模板文件，仅保留所需字段
```PHP 
<?php

use yii\helpers\Html;
use yii\widgets\ActiveForm;

/* @var $this yii\web\View */
/* @var $model backend\models\Admin */
/* @var $form yii\widgets\ActiveForm */
?>

<div class="admin-form">

    <?php $form = ActiveForm::begin(); ?>

    <?= $form->field($model, 'username')->textInput(['maxlength' => true]) ?>
    <?= $form->field($model, 'password')->passwordInput(['maxlength' => true]) ?>

    <?= $form->field($model, 'email')->textInput(['maxlength' => true]) ?>


    <div class="form-group">
        <?= Html::submitButton($model->isNewRecord ? Yii::t('app', 'Create') : Yii::t('app', 'Update'), ['class' => $model->isNewRecord ? 'btn btn-success' : 'btn btn-primary']) ?>
    </div>

    <?php ActiveForm::end(); ?>

</div>

```
> 表单
![](http://ww3.sinaimg.cn/large/6aedb651gw1fbejkwy8tnj20v10armxy.jpg)


#### 登录
1. 在后台Model目录新建LoginForm模型
2. 修改后台配置文件mian.php的user组件,将identityClass修改为生成的后台用户类
```php
'user' => [
            'identityClass' => 'backend\models\Admin',
            'enableAutoLogin' => true,
            'identityCookie' => ['name' => '_identity-backend', 'httpOnly' => true],
        ],
```
3. 修改后台控制器siteController的login方法，将实例化的登录模型改为刚新建的后台登录模型

#### 添加验证码
1. 在siteController中的behaviors允许验证码通过
```php
 public function behaviors()
    {
        return [
            'access' => [
                'class' => AccessControl::className(),
                'rules' => [
                    [
                        'actions' => ['login', 'error','captcha'],
                        'allow' => true,
                    ],
                    [
                        'actions' => ['logout', 'index'],
                        'allow' => true,
                        'roles' => ['@'],
                    ],

                ],

            ],
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => [
                    'logout' => ['post'],
                ],
            ],
        ];
    }
```
2. 在siteController中使用验证码组件模型
```php
    public function actions()
    {
        return [
            'error' => [
                'class' => 'yii\web\ErrorAction',
            ],
            'captcha' => [
                'class' => 'yii\captcha\CaptchaAction',
                'maxLength'=>4,
                'minLength'=>4,
            ],
        ];
    }
```
3. 在登录表单中use captcha类，添加验证码字段和输入框
```php
        <?= $form
            ->field($model, 'verifyCode')
            ->label(false)
            ->widget(Captcha::className(), [
                'template' => '<div class="input-group">
 {input}
 <span class="input-group-addon" style="padding-left:10px; padding-right:10px;">{image}</span>
 </div>',
                'options' => ['class' => 'form-control', 'maxlength' => "4", 'placeholder' => "验证码"],
                'imageOptions' => ['style' => 'height:20px', 'border' => '0', 'alt' => "点击更换验证码"]
            ]) ?>
```
4. 在登录表单中增加验证码字段和验证规则
```php
<?php
namespace backend\models;

use Yii;
use yii\base\Model;

/**
 * Login form
 */
class LoginForm extends Model
{
    public $username;
    public $password;
    public $verifyCode;
    public $rememberMe = true;

    private $_user;


    /**
     * @inheritdoc
     */
    public function rules()
    {
        return [
            // username and password are both required
            [['username', 'password'], 'required', 'message' => '不能为空'],
            // rememberMe must be a boolean value
            ['rememberMe', 'boolean'],
            // password is validated by validatePassword()
            ['password', 'validatePassword'],
            ['verifyCode', 'captcha', 'message' => '验证码不正确'],
        ];
    }

    /**
     *
     */
    public function attributeLabels()
    {
        return [
            'username' => '用户名',
            'password' => '密码',
            'verifyCode'=>'验证码'
        ];
    }

    /**
     * Validates the password.
     * This method serves as the inline validation for password.
     *
     * @param string $attribute the attribute currently being validated
     * @param array $params the additional name-value pairs given in the rule
     */
    public function validatePassword($attribute, $params)
    {
        if (!$this->hasErrors()) {
            $user = $this->getUser();
            if (!$user || !$user->validatePassword($this->password)) {
                $this->addError($attribute, '密码不正确');
            }
        }
    }

    /**
     * Logs in a user using the provided username and password.
     *
     * @return boolean whether the user is logged in successfully
     */
    public function login()
    {
        if ($this->validate()) {
            return Yii::$app->user->login($this->getUser(), $this->rememberMe ? 3600 * 24 * 30 : 0);
        } else {
            return false;
        }
    }

    /**
     * Finds user by [[username]]
     *
     * @return User|null
     */
    protected function getUser()
    {
        if ($this->_user === null) {
            $this->_user = Admin::findByUsername($this->username);
        }

        return $this->_user;
    }
}
```
![](http://ww1.sinaimg.cn/large/6aedb651gw1fbejl8n0o8j20ff0bs0t8.jpg)